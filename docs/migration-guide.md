# MODX → Astro Migration Guide

> Complete guide for migrating websites from MODX CMS to the Astro static site generator.

## Table of Contents

1. [System Overview](#system-overview)
2. [Requirements](#requirements)
3. [Project Structure](#project-structure)
4. [Single Site Migration](#single-site-migration)
5. [Batch Migration](#batch-migration)
6. [Theme Customization](#theme-customization)
7. [Keystatic CMS (Admin Panel)](#keystatic-cms-admin-panel)
8. [Deployment](#deployment)
9. [Testing](#testing)
10. [CLI Script Architecture](#cli-script-architecture)
11. [Troubleshooting](#troubleshooting)

---

## System Overview

The system consists of three components:

| Component | Purpose |
|-----------|---------|
| **Astro Theme** (`astro-theme/`) | Universal template with neutral design, CSS variables for colors/fonts, 14 components |
| **CLI Script** (`cli/migrate.js`) | Parses MODX SQL dump, extracts ContentBlocks, generates JSON files for Astro |
| **Batch Script** (`cli/batch-migrate.js`) | Processes multiple sites in a single run |

### Migration Flow

```
MODX SQL dump + assets/ directory
        ↓
  cli/migrate.js
        ↓
  src/content/pages/*.json    (pages)
  src/content/site-config.json (site settings)
  src/content/redirects.json  (redirects)
  public/assets/              (media files)
        ↓
  npx astro build
        ↓
  dist/  →  rsync → server
```

---

## Requirements

- **Node.js** ≥ 18
- **npm** ≥ 9
- **SSH access** to the server for deployment (rsync)
- **SQL dump** of the MODX website (mysqldump)
- **assets/** directory from the website (uploads, userupload, components)

### Installing Dependencies

```bash
# CLI script
cd cli/
npm install

# Astro theme
cd astro-theme/
npm install
```

---

## Project Structure

```
modx-to-astro/
├── cli/
│   ├── migrate.js           # Main migration script
│   ├── batch-migrate.js     # Batch migration for N sites
│   ├── migrate.test.js      # 48 unit tests (Jest)
│   └── package.json
│
├── astro-theme/
│   ├── src/
│   │   ├── components/       # 14 Astro components
│   │   │   ├── Header.astro
│   │   │   ├── Footer.astro
│   │   │   ├── Hero.astro
│   │   │   ├── Section.astro
│   │   │   ├── Grid.astro
│   │   │   ├── Gallery.astro
│   │   │   ├── Slider.astro
│   │   │   ├── FeatureList.astro
│   │   │   ├── Accordion.astro
│   │   │   ├── Tabs.astro
│   │   │   ├── Trenner.astro
│   │   │   ├── Quote.astro
│   │   │   ├── BlockRenderer.astro
│   │   │   └── BaseLayout.astro
│   │   ├── content/           # Content (generated by script)
│   │   │   ├── pages/         # JSON page files
│   │   │   ├── site-config.json
│   │   │   └── redirects.json
│   │   ├── content.config.ts  # Zod schemas for Content Collections
│   │   ├── pages/
│   │   │   ├── index.astro    # Home page
│   │   │   ├── [...slug].astro # All other pages
│   │   │   └── 404.astro      # Error page
│   │   └── styles/
│   │       └── global.css     # CSS variables, Tailwind
│   ├── keystatic.config.ts    # Keystatic CMS configuration
│   ├── astro.config.mjs       # Astro configuration (redirects, sitemap)
│   └── public/
│       └── assets/            # Media files (copied by script)
│
└── docs/
    └── migration-guide.md     # This guide
```

---

## Single Site Migration

### Step 1: Prepare Data

Obtain from the MODX server:

```bash
# SQL dump (mysqldump)
mysqldump -u user -p database_name > site.sql

# assets/ directory (rsync)
rsync -az user@server:/path/to/modx/assets/ ./site-assets/
```

### Step 2: Run Migration

```bash
cd cli/
node migrate.js \
  --sql ../site-data/site.sql \
  --assets ../site-data/assets \
  --out ../astro-theme/src/content \
  --verbose
```

#### Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `--sql` | ✅ | Path to the MODX SQL dump |
| `--assets` | ✅ | Path to the site's assets directory |
| `--out` | ✅ | Path to `src/content/` in the Astro theme |
| `--site` | ❌ | Site domain for canonical URLs |
| `--verbose` | ❌ | Verbose logging |

### Step 3: Verify Migration Results

```bash
# Check generated files
ls astro-theme/src/content/pages/
cat astro-theme/src/content/site-config.json | head -20

# Check media files
ls astro-theme/public/assets/uploads/ | wc -l
```

### Step 4: Build the Site

```bash
cd astro-theme/
npx astro build
```

The result will appear in `dist/`.

### Step 5: Local Preview

```bash
cd astro-theme/
npx astro preview    # Preview the built site on localhost
```

### Step 6: Deploy

```bash
rsync -az --delete dist/ user@server:~/www/site-name/
```

---

## Batch Migration

For processing dozens or hundreds of sites, use `batch-migrate.js`.

### Prepare Directory Structure

```
sites/
├── azotea/
│   ├── azotea.sql       # SQL dump
│   └── assets/          # Assets directory
├── kp-services/
│   ├── kpservices.sql
│   └── assets/
├── client-3/
│   ├── dump.sql
│   └── assets/
└── ...
```

### Running

```bash
cd cli/

# Migration only (generate JSON + copy assets)
node batch-migrate.js \
  --sites ../sites \
  --theme ../astro-theme \
  --output ../output

# Migration + build
node batch-migrate.js \
  --sites ../sites \
  --theme ../astro-theme \
  --output ../output \
  --build

# Migration + build + deploy
node batch-migrate.js \
  --sites ../sites \
  --theme ../astro-theme \
  --output ../output \
  --build \
  --deploy-host user@server \
  --deploy-base ~/www

# Process only specific sites
node batch-migrate.js \
  --sites ../sites \
  --theme ../astro-theme \
  --output ../output \
  --only azotea,kp-services

# Skip certain sites
node batch-migrate.js \
  --sites ../sites \
  --theme ../astro-theme \
  --output ../output \
  --skip broken-site
```

#### batch-migrate.js Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `--sites` | ✅ | Directory containing site folders |
| `--theme` | ✅ | Path to the Astro theme (template) |
| `--output` | ✅ | Output directory |
| `--only` | ❌ | Process only listed sites (comma-separated) |
| `--skip` | ❌ | Skip listed sites |
| `--build` | ❌ | Run `npx astro build` for each site |
| `--deploy-host` | ❌ | SSH host for rsync deployment |
| `--deploy-base` | ❌ | Base path on the server |
| `--verbose` | ❌ | Verbose logging |

### Report

After completion, a `batch-report.json` is created:

```json
{
  "total": 10,
  "success": 9,
  "failed": 1,
  "sites": [
    { "name": "azotea", "status": "success", "pages": 36, "duration": "4.2s" },
    { "name": "broken-site", "status": "failed", "error": "No SQL file found" }
  ]
}
```

---

## Theme Customization

### CSS Variables (Colors and Fonts)

The theme uses CSS variables that are automatically generated from `site-config.json`:

```json
{
  "companyName": "AZOTEA GmbH",
  "primaryColor": "#C8A96E",
  "secondaryColor": "#2B2B2B",
  "headingFont": "Playfair Display",
  "bodyFont": "Source Sans Pro",
  "logo": "/assets/uploads/logo.png",
  "favicon": "/assets/uploads/favicon.png"
}
```

These values are passed to `<BaseLayout>` and define:
- `--color-primary` / `--color-secondary` — main colors
- `--font-heading` / `--font-body` — fonts (loaded via Google Fonts)

### Components

Each Content Block from MODX maps to an Astro component:

| MODX Layout ID | Component | Description |
|-----------------|-----------|-------------|
| 1 | `Section.astro` | Section with background, anchor link (#anchor) |
| 2 | `Hero.astro` | Hero banner with background image |
| 3 | `Grid.astro` | CSS Grid (1–4 columns) |
| 4 | `Gallery.astro` | Image gallery |
| 5 | `Slider.astro` | Slider with auto-scroll |
| 6 | `Accordion.astro` | FAQ accordion |
| 7 | `Tabs.astro` | Tabbed content |
| 8 | `FeatureList.astro` | Feature list with icons |
| 9 | `Trenner.astro` | Horizontal divider |
| 10 | `Quote.astro` | Quote block |

### Content Blocks Within Sections

| Field ID | Type | Fields |
|----------|------|--------|
| 2 | heading | `text`, `level` |
| 3 | text | `content` (HTML) |
| 4 | image | `src`, `alt`, `width`, `height`, `cover` |
| 22 | gallery | `images[]` |
| 37 | spacer | (skipped) |

---

## Keystatic CMS (Admin Panel)

Keystatic is a local CMS (no server/database) that edits JSON files directly.

### Important: Keystatic works only in development mode!

In production (static build), the `/keystatic` route **does not exist**. This is by design.

### Usage

```bash
cd astro-theme/

# Start with admin panel
KEYSTATIC=true npm run dev

# Open in browser
open http://localhost:4321/keystatic
```

### What You Can Edit

- **Site Config** (singleton): company name, colors, fonts, logo, favicon, social media links
- **Pages** (collection): title, description, content blocks for each page

### Workflow

1. Run `KEYSTATIC=true npm run dev`
2. Open `/keystatic` in the browser
3. Make changes (they are saved to JSON files)
4. Rebuild: `npx astro build`
5. Deploy: `rsync -az --delete dist/ user@server:~/www/`

---

## Deployment

### Option 1: Makefile (Recommended for local workflow)

```bash
# 1. Configure .env
cp .env.example .env
# Edit .env — set SQL_PATH, ASSETS_PATH, DEPLOY_HOST, DEPLOY_PATH

# 2. Full pipeline in one command
make all              # = migrate + build + deploy

# Or step by step:
make migrate          # SQL → JSON
make build            # JSON → HTML
make deploy           # HTML → server (zero-downtime)

# Roll back to the previous release:
make rollback
```

### Option 2: deploy.sh Script (Zero-Downtime)

```bash
# Deploy
./scripts/deploy.sh user@server /var/www/vhosts/site.ch/httpdocs

# Rollback
./scripts/deploy.sh --rollback
```

**How zero-downtime works:**
1. `rsync` uploads files to `{DEPLOY_PATH}-staging/`
2. Atomic swap: current → `{DEPLOY_PATH}-prev`, staging → current
3. The site is never unreachable during deployment
4. Rollback = reverse swap (instant)

### Option 3: GitLab CI/CD (Automated)

#### Setup

1. **GitLab Variables** (Settings → CI/CD → Variables):

   | Variable | Value | Protected |
   |----------|-------|-----------|
   | `SSH_PRIVATE_KEY` | Contents of the private SSH key | ✅ |
   | `DEPLOY_HOST` | `user@server.example.com` | ✅ |
   | `DEPLOY_PATH` | `/var/www/vhosts/site.ch/httpdocs` | ❌ |
   | `SITE_DOMAIN` | `site.ch` | ❌ |

2. **Repository structure for each site:**

   ```
   site-repo/
   ├── data/
   │   ├── dump.sql         # Site SQL dump
   │   └── assets/          # Media files
   ├── cli/                 # git submodule or copy
   ├── astro-theme/         # git submodule or copy
   └── .gitlab-ci.yml       # Copy from the main repo
   ```

3. **Push to `main`** → stages run automatically:

   ```
   migrate → test → build → deploy (manual)
   ```

#### Pipeline Stages

| Stage | What It Does | Trigger |
|-------|-------------|---------|
| `migrate` | SQL + assets → JSON content | auto |
| `test` | 48 CLI unit tests | auto |
| `build` | `npx astro build` → static HTML | auto |
| `deploy` | rsync + zero-downtime swap | manual (button) |
| `rollback` | Restore previous release | manual (button) |

#### Rollback

In GitLab UI → Pipeline → click the **rollback** button. Instantly restores the previous release.

### Option 4: Batch Deploy (For Mass Migration)

```bash
# Migration + build + deploy for all sites
node cli/batch-migrate.js \
  --sites ./sites \
  --theme ./astro-theme \
  --output ./output \
  --build \
  --deploy-host user@server \
  --deploy-base /var/www/vhosts
```

### Plesk-Specific Notes

- **Document Root**: usually `/var/www/vhosts/domain.ch/httpdocs/`
- For Plesk multi-domain setups: `DEPLOY_PATH=/var/www/vhosts/domain.ch/httpdocs`
- `.htaccess` and `.well-known` are automatically excluded from rsync
- No PHP/MySQL dependency on the server — pure static hosting

---

## Testing

### Running Tests

```bash
cd cli/
npm test              # Run all 48 tests
npm run test:watch    # Watch mode (auto-restart)
```

### Test Coverage

| Group | Tests | Description |
|-------|-------|-------------|
| parseSQLValue | 6 | Parsing individual SQL values |
| parseSQLValues | 4 | Parsing VALUES rows |
| mapRowToResource | 2 | Mapping columns to resource object |
| cleanHtml | 3 | HTML cleanup (br tags, whitespace) |
| cleanModxTags | 4 | Removing MODX tags ([[...]], [[$...]]) |
| extractTextFromHtml | 3 | Extracting plain text from HTML |
| mapPosition | 2 | CSS classes → background position |
| mapMinHeight | 1 | CSS classes → hero height |
| mapVerticalAlign | 1 | CSS classes → vertical alignment |
| mapTrennerWidth | 1 | CSS classes → divider width |
| normalizeFilename | 4 | Filename normalization (case, spaces, .jpeg→.jpg) |
| resolveImagePath | 4 | Image path resolution |
| extractClientConfig | 2 | ClientConfig settings extraction |
| extractRedirects | 3 | SEOSuite redirect extraction |
| processContentFields | 4 | ContentBlocks field processing |
| parseArgs | 3 | CLI argument parsing |
| stripTitleFromHtml | 1 | Removing headings from HTML |

### Adding New Tests

```javascript
// migrate.test.js
describe('myNewFunction', () => {
  test('should do something', () => {
    const result = migrate.myNewFunction(input);
    expect(result).toBe(expectedOutput);
  });
});
```

All functions are exported via `module.exports` at the end of `migrate.js`.

---

## CLI Script Architecture

### Main Exported Functions

#### SQL Parsing
- `parseSQLValue(val)` — Parses a single SQL value (string, number, NULL)
- `parseSQLValues(str)` — Parses VALUES(...),(...) into an array of arrays
- `extractResources(sql)` — Extracts resources from INSERT INTO modx_site_content
- `extractClientConfig(sql)` — Extracts ClientConfig settings
- `extractRedirects(sql)` — Extracts SEOSuite redirects

#### HTML Processing
- `cleanHtml(html)` — Removes br tags, trims whitespace
- `cleanModxTags(html)` — Removes MODX tags ([[$chunk]], [[!snippet]])
- `extractTextFromHtml(html)` — Extracts plain text from HTML
- `stripTitleFromHtml(html)` — Removes h1–h6 from HTML

#### Mapping
- `mapRowToResource(row)` — 44-column array → named-field object
- `mapPosition(cssClass)` — CSS class → 'top'/'bottom'/'left'/'right'/'center'
- `mapMinHeight(cssClass)` — CSS class → 'full'/'medium'/'small'
- `mapVerticalAlign(cssClass)` — CSS class → 'top'/'bottom'/'center'
- `mapTrennerWidth(cssClass)` — CSS class → '20'/'40'/'60'/'full'

#### Images
- `resolveImagePath(path)` — Normalizes image path
- `normalizeFilename(name)` — Normalizes filename (lowercase, spaces→underscores, .jpeg→.jpg)
- `fuzzyFindFile(filename)` — Fuzzy file search across asset directories

#### Content
- `processContentFields(fields, settings)` — Processes ContentBlocks field array
- `processContentLayout(layout, resources)` — Processes a single layout (section/grid)
- `buildSiteConfig(resources, clientConfig, pages)` — Builds site-config.json

### Fuzzy Image Matching

The script automatically finds images when names don't match exactly:

- `MyFile.JPG` ↔ `myfile.jpg` (case)
- `my file.jpg` ↔ `my_file.jpg` (spaces/underscores)
- `photo.jpeg` ↔ `photo.jpg` (extensions)
- Also searches the phpthumbof cache

---

## Troubleshooting

### Issue: Astro build fails with Content Collections error

```
InvalidContentEntryDataError: pages → redirects data does not match collection schema
```

**Cause:** `redirects.json` or `site-config.json` ended up in `src/content/pages/`.

**Solution:**
```bash
rm -f astro-theme/src/content/pages/redirects.json
rm -f astro-theme/src/content/pages/site-config.json
```

### Issue: Keystatic /keystatic returns 404

**Cause:** Keystatic works only in development mode. The `/keystatic` route does not exist on the static site.

**Solution:** Run `KEYSTATIC=true npm run dev` locally.

### Issue: Broken images on the site

**Diagnosis:**
```bash
cd astro-theme/
# Find all image references in JSON
grep -roh 'src":"[^"]*"' src/content/pages/ | sort -u

# Check if files exist
grep -roh 'src":"[^"]*"' src/content/pages/ | sed 's/src":"//;s/"//' | while read f; do
  [[ ! -f "public$f" ]] && echo "MISSING: $f"
done
```

**Possible causes:**
1. File was not copied from assets/
2. Case/extension mismatch → script should find it via fuzzyFindFile
3. File is in the phpthumbof cache → script searches automatically

### Issue: Company name displays next to the logo in the header

**Cause:** Older logic showed both elements simultaneously.

**Solution:** Already fixed. If `logo` is set in site-config.json, only the logo is displayed. If `logo` is empty, the text company name is shown.

### Issue: Navigation is missing some menu items

**Diagnosis:**
```bash
cat astro-theme/src/content/site-config.json | jq '.navigation'
```

**Cause:** Resources with `hidemenu=1` or `published=0` are not included in the navigation.

---

## FAQ

**Q: Can I migrate a site without ContentBlocks?**
A: Yes. If no ContentBlocks are found, the script uses the `content` field from modx_site_content as a richtext block.

**Q: How long does migrating a single site take?**
A: SQL parsing + JSON generation — 1–3 seconds. Astro build — 2–5 seconds. rsync deploy — depends on the size of assets.

**Q: How do I add a new block type?**
A: 1) Add a case in `processContentFields()` in `migrate.js`. 2) Create an Astro component in `src/components/`. 3) Add rendering logic in `BlockRenderer.astro`.

**Q: Does it work with Astro 5?**
A: Yes. It uses `output: 'static'` (Astro 5 removed the `'hybrid'` option).

---

## Checklist: Migrating a New Client Site

Step-by-step checklist for migrating a single site from start to finish.

### Preparation (5 min)

- [ ] Obtain the SQL dump (`mysqldump -u root -p db_name > dump.sql`)
- [ ] Download the `assets/` directory from the MODX server (`rsync -az ...`)
- [ ] Create `.env` with site data (copy from `.env.example`)
- [ ] Set `SQL_PATH`, `ASSETS_PATH`, `SITE_DOMAIN`, `DEPLOY_HOST`, `DEPLOY_PATH`

### Migration (10 sec)

- [ ] `make migrate` — generate JSON content
- [ ] Check the log: 0 edge cases, correct number of pages
- [ ] Review `site-config.json` — name, logo, colors, navigation

### Build (5 sec)

- [ ] `make build` — build the static site
- [ ] `make preview` — check locally at localhost:4321
- [ ] Visual check: home page, inner page, mobile version

### Quality Check (5 min)

- [ ] Logo displays correctly
- [ ] Colors match the original site
- [ ] Navigation is complete, dropdowns work
- [ ] Images load (no broken links)
- [ ] Contact form is displayed
- [ ] Footer: address, phone, email are correct
- [ ] 404 page works
- [ ] Redirects work (check 2–3 old URLs)

### Deploy (30 sec)

- [ ] `make deploy` — zero-downtime deploy
- [ ] Verify the production site in the browser
- [ ] DNS: if needed — point the A record to the server

### Post-Deploy

- [ ] If needed: `KEYSTATIC=true npm run dev` → edits → `make build` → `make deploy`
- [ ] If issues arise: `make rollback`
