---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ContactSection from '../components/ContactSection.astro';
import { getImage } from 'astro:assets';
import { resolveImage } from '../utils/imageLoader';

interface Props {
  title: string;
  description?: string;
  lang?: string;
  canonicalUrl?: string;
  ogImage?: string;
  siteConfig?: any;
  hasHero?: boolean;
  blocks?: any[];
}

const {
  title,
  description,
  lang = 'de',
  canonicalUrl,
  ogImage,
  siteConfig = {},
  hasHero = false,
  blocks = [],
} = Astro.props;

const navigation = siteConfig.navigation || [];
const companyName = siteConfig.companyName || '';
const companyAddress = siteConfig.companyAddress || '';
const companyPhone = siteConfig.companyPhone || '';
const companyEmail = siteConfig.companyEmail || '';
const logo = siteConfig.logo || '';
const socialLinks = siteConfig.socialLinks || [];
const theme = siteConfig.theme || {};
const showContactSection = siteConfig.showContactSection || false;
const showCompanyName = siteConfig.showCompanyName !== false; // default true
const maxLayoutWidth = siteConfig.maxLayoutWidth || 1200;
const analyticsId = siteConfig.analyticsId || '';
const analyticsType = siteConfig.analyticsType || 'analytics';

// Auto-extract OG image from page blocks if not explicitly provided
function findFirstImage(blocks: any[]): string {
  for (const block of blocks) {
    if (block.type === 'hero' && block.backgroundImage) return block.backgroundImage;
    if (block.type === 'image' && block.src) return block.src;
    if (block.type === 'gallery' && block.images?.[0]?.src) return block.images[0].src;
    if (block.type === 'slider' && block.slides?.[0]?.image) return block.slides[0].image;
    if (block.type === 'section' && block.children) {
      const found = findFirstImage(block.children);
      if (found) return found;
    }
    if (block.type === 'grid' && block.cells) {
      for (const cell of block.cells) {
        const found = findFirstImage(cell);
        if (found) return found;
      }
    }
  }
  return '';
}

const resolvedOgImage = ogImage || findFirstImage(blocks);
// Make OG image absolute URL
const absoluteOgImage = resolvedOgImage
  ? (resolvedOgImage.startsWith('http') ? resolvedOgImage : new URL(resolvedOgImage, Astro.site).href)
  : undefined;

// Pre-compute hero image preload URLs so BaseLayout can add <link rel="preload"> in <head>.
// Using getImage() gets the exact hashed URLs that Hero.astro <Image widths> will use â€” perfect match.
let heroPreloadSrc = '';
let heroPreloadSrcset = '';
const heroBlock = blocks.find((b: any) => b.type === 'hero' && b.backgroundImage);
if (heroBlock?.backgroundImage) {
  const meta = await resolveImage(heroBlock.backgroundImage);
  if (meta) {
    try {
      const [img640, img1280, img1920] = await Promise.all([
        getImage({ src: meta, width: 640, format: 'webp' }),
        getImage({ src: meta, width: 1280, format: 'webp' }),
        getImage({ src: meta, width: 1920, format: 'webp' }),
      ]);
      heroPreloadSrc = img1920.src;
      heroPreloadSrcset = `${img640.src} 640w, ${img1280.src} 1280w, ${img1920.src} 1920w`;
    } catch { /* fallback: no preload, hero still loads correctly */ }
  }
}
---
<BaseLayout title={title} description={description} lang={lang} canonicalUrl={canonicalUrl} ogImage={absoluteOgImage} heroPreloadSrc={heroPreloadSrc} heroPreloadSrcset={heroPreloadSrcset} theme={theme} favicon={siteConfig.favicon} maxLayoutWidth={maxLayoutWidth} analyticsId={analyticsId} analyticsType={analyticsType}>
  <div class="min-h-screen flex flex-col">
  <Header navigation={navigation} companyName={showCompanyName ? companyName : ''} logo={logo} socialLinks={socialLinks} transparent={hasHero} />
  <main class="flex-1" id="content">
    <slot />
  </main>
  {showContactSection && (
    <ContactSection
      companyName={companyName}
      companyAddress={companyAddress}
      companyPhone={companyPhone}
      companyEmail={companyEmail}
      companyWebsite={siteConfig.companyWebsite || ''}
      openingHours={siteConfig.openingHours || ''}
      mapsEmbed={siteConfig.mapsEmbed || ''}
      middleInfos={siteConfig.middleInfos || ''}
      recipientEmail={companyEmail}
    />
  )}
  <Footer
    companyName={companyName}
    companyAddress={companyAddress}
    companyPhone={companyPhone}
    companyEmail={companyEmail}
    navigation={navigation}
    socialLinks={socialLinks}
  />
  </div>
</BaseLayout>
