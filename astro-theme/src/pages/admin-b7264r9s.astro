---
/**
 * Admin Panel â€” /admin-b7264r9s
 *
 * Password is checked client-side using Web Crypto SHA-256.
 * The hash is baked into HTML at build time from ADMIN_PASSWORD_HASH env var.
 * Run `node scripts/setup-admin.js` then rebuild to set a new password.
 */

// Load all page JSON at build time â†’ injected as JS variable
const rawPages = import.meta.glob('../content/pages/**/*.json', { eager: true });
const siteConfigRaw = await import('../content/site-config.json').catch(() => ({ default: {} }));

const siteConfig = siteConfigRaw.default as Record<string, unknown>;
const siteName   = (siteConfig.siteName as string) || (siteConfig.name as string) || 'Site';
const siteUrl    = (siteConfig.url as string) || import.meta.env.SITE || '';

// Build structured page map for client injection
const pageMap: Record<string, unknown> = {};
for (const [path, mod] of Object.entries(rawPages)) {
  const key = path
    .replace('../content/pages/', '')
    .replace('/index.json', '')
    .replace('.json', '');
  pageMap[key] = (mod as { default?: unknown }).default ?? mod;
}

const passwordHash    = import.meta.env.ADMIN_PASSWORD_HASH    || '';
const rebuildWebhook  = import.meta.env.ADMIN_REBUILD_WEBHOOK  || '';
const configured      = !!passwordHash;
---

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin Â· {siteName}</title>

  <!-- monaco-like editor minimal loading â€” use textarea instead (no CDN dep) -->

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0e1117;
      --surface:  #161b27;
      --border:   #2d3545;
      --accent:   #3b82f6;
      --accent-h: #2563eb;
      --danger:   #ef4444;
      --success:  #22c55e;
      --text:     #e2e8f0;
      --muted:    #94a3b8;
      --sidebar-w: 280px;
      --header-h:  56px;
    }

    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

    /* â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 1rem;
    }
    #login-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 2.5rem 2rem; width: 100%; max-width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    #login-box .logo { font-size: 2rem; margin-bottom: .5rem; text-align: center; }
    #login-box h1 { font-size: 1.25rem; font-weight: 600; text-align: center; margin-bottom: .25rem; }
    #login-box .sub { color: var(--muted); font-size: .85rem; text-align: center; margin-bottom: 2rem; }
    label { display: block; font-size: .8rem; font-weight: 500; color: var(--muted); margin-bottom: .35rem; text-transform: uppercase; letter-spacing: .05em; }
    input[type="password"] {
      width: 100%; padding: .65rem .85rem; background: var(--bg);
      border: 1px solid var(--border); border-radius: 8px; color: var(--text);
      font-size: .95rem; transition: border-color .15s;
    }
    input[type="password"]:focus { outline: none; border-color: var(--accent); }
    .btn-primary {
      width: 100%; margin-top: 1.25rem; padding: .75rem 1rem;
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; font-size: .95rem; font-weight: 600;
      cursor: pointer; transition: background .15s;
    }
    .btn-primary:hover { background: var(--accent-h); }
    .btn-primary:disabled { background: #374151; color: var(--muted); cursor: not-allowed; }
    .error-msg { color: var(--danger); font-size: .82rem; margin-top: .75rem; text-align: center; min-height: 1.2em; }

    /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: none; height: 100vh; flex-direction: column; }

    /* Top bar */
    #topbar {
      height: var(--header-h); background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 1.25rem; gap: 1rem;
      position: sticky; top: 0; z-index: 10; flex-shrink: 0;
    }
    #topbar .site-name { font-weight: 700; font-size: 1rem; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    #topbar .site-url  { color: var(--muted); font-size: .8rem; }
    .icon-btn {
      display: flex; align-items: center; gap: .4rem; padding: .45rem .85rem;
      background: transparent; border: 1px solid var(--border); border-radius: 7px;
      color: var(--text); font-size: .82rem; cursor: pointer; transition: all .15s; white-space: nowrap;
    }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
    .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
    .icon-btn.rebuild-btn { border-color: var(--success); color: var(--success); }
    .icon-btn.rebuild-btn:hover { background: rgba(34,197,94,.1); }
    .icon-btn.rebuild-btn.loading { border-color: var(--muted); color: var(--muted); pointer-events: none; }

    /* Main area */
    #main { display: flex; flex: 1; overflow: hidden; }

    /* Sidebar */
    #sidebar {
      width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
    }
    #sidebar-search {
      padding: .75rem; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    #sidebar-search input {
      width: 100%; padding: .5rem .75rem; background: var(--bg);
      border: 1px solid var(--border); border-radius: 7px;
      color: var(--text); font-size: .85rem;
    }
    #sidebar-search input:focus { outline: none; border-color: var(--accent); }
    #page-list { list-style: none; overflow-y: auto; flex: 1; padding: .4rem 0; }
    #page-list li {
      padding: .5rem .9rem; cursor: pointer; border-radius: 6px; margin: 0 .4rem .1rem;
      font-size: .85rem; color: var(--muted); display: flex; align-items: center; gap: .5rem;
      transition: all .1s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    #page-list li:hover { background: var(--bg); color: var(--text); }
    #page-list li.active { background: rgba(59,130,246,.15); color: var(--accent); }
    #page-list li .page-icon { flex-shrink: 0; }
    #page-list li .page-title { overflow: hidden; text-overflow: ellipsis; }

    /* Editor panel */
    #editor-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #editor-toolbar {
      padding: .6rem 1rem; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: .5rem; flex-shrink: 0;
    }
    #editor-toolbar .page-slug {
      font-family: "SFMono-Regular", Consolas, monospace; font-size: .82rem;
      color: var(--muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    #editor-toolbar .view-link { font-size: .8rem; color: var(--accent); text-decoration: none; }
    #editor-toolbar .view-link:hover { text-decoration: underline; }
    .small-btn {
      padding: .35rem .75rem; background: transparent; border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: .8rem; cursor: pointer; white-space: nowrap;
      transition: all .1s;
    }
    .small-btn:hover { background: var(--border); }
    .small-btn.save-btn { border-color: var(--success); color: var(--success); }
    .small-btn.save-btn:hover { background: rgba(34,197,94,.1); }
    .small-btn.dl-btn { border-color: var(--accent); color: var(--accent); }
    .small-btn.dl-btn:hover { background: rgba(59,130,246,.1); }

    #editor-textarea {
      flex: 1; background: var(--bg); color: #a8d0ff;
      border: none; padding: 1rem 1.25rem; font-family: "SFMono-Regular", Consolas, "Courier New", monospace;
      font-size: .82rem; line-height: 1.65; resize: none; outline: none;
      overflow: auto; tab-size: 2;
    }
    #editor-textarea::placeholder { color: var(--border); }
    #editor-status { padding: .35rem 1rem; font-size: .75rem; color: var(--muted); background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; }

    /* Welcome panel */
    #welcome-panel {
      flex: 1; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: .75rem; color: var(--muted); text-align: center; padding: 2rem;
    }
    #welcome-panel .big-icon { font-size: 3rem; }
    #welcome-panel h2 { font-size: 1.1rem; color: var(--text); }
    #welcome-panel p { max-width: 360px; line-height: 1.6; font-size: .85rem; }
    #welcome-panel .stats { display: flex; gap: 2rem; margin-top: 1rem; }
    #welcome-panel .stat { text-align: center; }
    #welcome-panel .stat .val { font-size: 2rem; font-weight: 700; color: var(--accent); }
    #welcome-panel .stat .lbl { font-size: .75rem; color: var(--muted); margin-top: .2rem; }

    /* Rebuild result toast */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100;
      padding: .75rem 1.25rem; border-radius: 10px; font-size: .85rem; font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,.4); display: none;
      animation: slideIn .25s ease;
    }
    #toast.success { background: #052e16; border: 1px solid var(--success); color: var(--success); }
    #toast.error   { background: #2d0505; border: 1px solid var(--danger);  color: var(--danger); }
    @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Not configured */
    #not-configured {
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
      flex-direction: column; gap: 1rem; text-align: center; padding: 2rem; color: var(--muted);
    }
    #not-configured h1 { font-size: 1.1rem; color: var(--text); }
    #not-configured code { background: var(--surface); padding: .25rem .6rem; border-radius: 5px; font-size: .85rem; color: var(--accent); }
  </style>
</head>
<body>

<!-- â”€â”€ Not Configured â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{!configured && (
  <div id="not-configured">
    <div style="font-size:2.5rem">ğŸ”§</div>
    <h1>Admin not configured</h1>
    <p>Run <code>node scripts/setup-admin.js</code> then rebuild the site.</p>
  </div>
)}

<!-- â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{configured && (
  <>
  <div id="login-screen">
    <div id="login-box">
      <div class="logo">ğŸ”</div>
      <h1>Admin Panel</h1>
      <div class="sub">{siteName}</div>
      <label for="pwd">Password</label>
      <input type="password" id="pwd" autocomplete="current-password" placeholder="Enter admin password" autofocus />
      <button class="btn-primary" id="login-btn" type="button">Sign in</button>
      <div class="error-msg" id="login-error"></div>
    </div>
  </div>

  <!-- â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="app">
    <header id="topbar">
      <span class="site-name">{siteName}</span>
      {siteUrl && <a class="site-url icon-btn" href={siteUrl} target="_blank" rel="noopener">â†— Site</a>}
      <button class="icon-btn rebuild-btn" id="rebuild-btn" style={rebuildWebhook ? '' : 'display:none'}>
        â–² Rebuild
      </button>
      <button class="icon-btn danger" id="logout-btn">Sign out</button>
    </header>

    <div id="main">
      <aside id="sidebar">
        <div id="sidebar-search">
          <input type="text" id="search-input" placeholder="Search pagesâ€¦" autocomplete="off" />
        </div>
        <ul id="page-list"></ul>
      </aside>

      <section id="editor-panel">
        <!-- Welcome splash (shown before any page selected) -->
        <div id="welcome-panel">
          <div class="big-icon">ğŸ“„</div>
          <h2>Select a page to edit</h2>
          <p>Choose a page from the sidebar to view and edit its JSON content. Download the modified file and upload it via SFTP, then rebuild.</p>
          <div class="stats">
            <div class="stat"><div class="val" id="stat-pages">â€“</div><div class="lbl">Pages</div></div>
            <div class="stat"><div class="val" id="stat-blocks">â€“</div><div class="lbl">Content blocks</div></div>
          </div>
        </div>

        <!-- Editor (hidden until page selected) -->
        <div id="editor-wrap" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
          <div id="editor-toolbar">
            <span class="page-slug" id="editor-slug"></span>
            <a class="view-link" id="editor-live-link" href="#" target="_blank" rel="noopener" style="display:none">â†— View live</a>
            <button class="small-btn dl-btn" id="dl-btn">â†“ Download JSON</button>
          </div>
          <textarea id="editor-textarea" spellcheck="false" placeholder="Select a page from the sidebarâ€¦"></textarea>
          <div id="editor-status">Ready</div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast"></div>
  </>
)}

<script is:inline define:vars={{ passwordHash, rebuildWebhook, pageMap, siteUrl }}>
(function () {
  'use strict';

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sha256hex(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function showToast(msg, type = 'success', dur = 4000) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.className = type;
    t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, dur);
  }

  function setStatus(msg) {
    const el = document.getElementById('editor-status');
    if (el) el.textContent = msg;
  }

  // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SESSION_KEY = 'admin_authed_b7264r9s';

  async function tryLogin() {
    const pwd = document.getElementById('pwd')?.value || '';
    const err = document.getElementById('login-error');
    const btn = document.getElementById('login-btn');
    if (!pwd) return;

    btn.disabled = true;
    btn.textContent = 'Checkingâ€¦';
    const hash = await sha256hex(pwd);

    if (hash === passwordHash) {
      sessionStorage.setItem(SESSION_KEY, '1');
      showApp();
    } else {
      if (err) { err.textContent = 'Incorrect password. Try again.'; }
      btn.disabled = false;
      btn.textContent = 'Sign in';
    }
  }

  function logout() {
    sessionStorage.removeItem(SESSION_KEY);
    document.getElementById('app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    const pwd = document.getElementById('pwd');
    if (pwd) { pwd.value = ''; pwd.focus(); }
  }

  // â”€â”€ Build page list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentSlug = null;

  function countBlocks(obj) {
    if (Array.isArray(obj)) return obj.length;
    if (obj && typeof obj === 'object') {
      return Object.values(obj).reduce((a, v) => a + countBlocks(v), 0);
    }
    return 0;
  }

  function buildSidebar(filter = '') {
    const ul = document.getElementById('page-list');
    if (!ul) return;
    ul.innerHTML = '';
    const fl = filter.toLowerCase();
    let total = 0, totalBlocks = 0;

    for (const [slug, data] of Object.entries(pageMap)) {
      const title = (data?.title || data?.meta?.title || slug).toString();
      if (fl && !title.toLowerCase().includes(fl) && !slug.toLowerCase().includes(fl)) continue;

      const blocksArr = data?.blocks || data?.content || [];
      totalBlocks += Array.isArray(blocksArr) ? blocksArr.length : 0;
      total++;

      const li = document.createElement('li');
      li.dataset.slug = slug;
      li.className = slug === currentSlug ? 'active' : '';
      li.innerHTML = `<span class="page-icon">ğŸ“„</span><span class="page-title">${title}</span>`;
      li.addEventListener('click', () => openPage(slug));
      ul.appendChild(li);
    }

    if (!filter) {
      const sp = document.getElementById('stat-pages');
      const sb = document.getElementById('stat-blocks');
      if (sp) sp.textContent = total;
      if (sb) sb.textContent = totalBlocks;
    }
  }

  function openPage(slug) {
    currentSlug = slug;
    const data = pageMap[slug];
    const json = JSON.stringify(data, null, 2);

    // Update sidebar active
    document.querySelectorAll('#page-list li').forEach(li => {
      li.classList.toggle('active', li.dataset.slug === slug);
    });

    // Show editor
    document.getElementById('welcome-panel').style.display = 'none';
    const wrap = document.getElementById('editor-wrap');
    wrap.style.display = 'flex';

    document.getElementById('editor-slug').textContent = slug + '.json';
    document.getElementById('editor-textarea').value = json;
    setStatus(`${json.length.toLocaleString()} chars Â· ${(json.length / 1024).toFixed(1)} KB`);

    // Live link
    const link = document.getElementById('editor-live-link');
    if (link && siteUrl) {
      const idx = slug === 'index' || slug === 'home';
      const pageSlug = idx ? '' : ('/' + slug);
      link.href = siteUrl.replace(/\/$/, '') + pageSlug;
      link.style.display = '';
    }
  }

  // â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function downloadCurrent() {
    const ta = document.getElementById('editor-textarea');
    if (!ta || !currentSlug) return;
    let json;
    try {
      JSON.parse(ta.value); // validate
      json = ta.value;
    } catch (e) {
      showToast('âš  Invalid JSON â€” fix errors before downloading', 'error');
      return;
    }
    const blob = new Blob([json], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = currentSlug.replace(/\//g, '__') + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
    setStatus('Downloaded âœ“');
    showToast(`Downloaded ${a.download}`, 'success');
  }

  // â”€â”€ Rebuild â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function triggerRebuild() {
    if (!rebuildWebhook) return;
    const btn = document.getElementById('rebuild-btn');
    btn.classList.add('loading');
    btn.textContent = 'â³ Rebuildingâ€¦';
    try {
      const resp = await fetch(rebuildWebhook, { method: 'POST' });
      if (resp.ok) {
        showToast('âœ“ Rebuild triggered successfully! Site will update in 1â€“2 min.', 'success', 6000);
      } else {
        showToast(`âœ— Webhook returned ${resp.status}`, 'error');
      }
    } catch (e) {
      showToast(`âœ— Could not reach webhook: ${e.message}`, 'error');
    }
    btn.classList.remove('loading');
    btn.textContent = 'â–² Rebuild';
  }

  // â”€â”€ Show app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    const app = document.getElementById('app');
    app.style.display = 'flex';
    buildSidebar();
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', () => {
    // Auto-login if session still active
    if (sessionStorage.getItem(SESSION_KEY) === '1') {
      showApp();
    }

    // Login interactions
    document.getElementById('login-btn')?.addEventListener('click', tryLogin);
    document.getElementById('pwd')?.addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });
    document.getElementById('logout-btn')?.addEventListener('click', logout);
    document.getElementById('rebuild-btn')?.addEventListener('click', triggerRebuild);
    document.getElementById('dl-btn')?.addEventListener('click', downloadCurrent);

    // Sidebar search
    document.getElementById('search-input')?.addEventListener('input', e => {
      buildSidebar(e.target.value);
    });
  });

}());
</script>
</body>
</html>
