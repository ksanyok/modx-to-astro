---
import { Image } from 'astro:assets';
import { resolveImage } from '../utils/imageLoader';
import { socialIcons, socialLabel } from '../utils/socialIcons';

interface NavItem {
  label: string;
  href: string;
  children?: Array<{ label: string; href: string }>;
}

interface Props {
  navigation?: NavItem[];
  companyName?: string;
  logo?: string;
  socialLinks?: Array<{ platform: string; url: string }>;
  transparent?: boolean;
}

const { navigation = [], companyName = 'Company', logo = '', socialLinks = [], transparent = false } = Astro.props;
const currentPath = Astro.url.pathname.replace(/\/$/, '') || '/';
const resolvedLogo = logo ? await resolveImage(logo) : null;
---
<header
  class:list={[
    'sticky top-0 z-50 transition-all duration-300',
    transparent ? 'header-transparent bg-transparent border-b border-transparent' : 'bg-white/90 backdrop-blur-xl border-b border-(--color-border-light)',
  ]}
  data-transparent={transparent ? 'true' : undefined}
>
  <div class="max-w-6xl mx-auto px-5 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16 sm:h-[72px]">
      <a href="/" class="flex items-center gap-2.5 shrink-0 group">
        {resolvedLogo ? (
          <Image src={resolvedLogo} alt={companyName} height={80} loading="eager" format="webp" class="h-8 sm:h-10 w-auto object-contain transition-transform duration-300 group-hover:scale-105" />
        ) : logo ? (
          <img src={logo} alt={companyName} class="h-8 sm:h-10 w-auto object-contain transition-transform duration-300 group-hover:scale-105" />
        ) : (
          <span class:list={[
            'text-lg sm:text-xl font-bold tracking-tight transition-colors duration-300',
            transparent ? 'text-white header-brand' : 'text-(--color-primary)',
          ]}>{companyName}</span>
        )}
      </a>

      <div class="hidden md:flex items-center gap-1">
        <nav class="flex items-center gap-1" aria-label="Main navigation">
          {navigation.map((item) => {
            const itemPath = item.href.replace(/\/$/, '') || '/';
            const isActive = currentPath === itemPath || (itemPath !== '/' && currentPath.startsWith(itemPath));
            const hasChildren = item.children && item.children.length > 0;
            return (
              <div class:list={['relative', hasChildren ? 'dropdown-parent group' : '']}>
                <a
                  href={item.href}
                  class:list={[
                    'header-nav-link relative px-4 py-2 rounded-full text-[13px] font-medium tracking-wide transition-all duration-200 inline-flex items-center gap-1',
                    isActive
                      ? (transparent ? 'text-white bg-white/15' : 'text-(--color-accent) bg-(--color-accent-light)')
                      : (transparent ? 'text-white/80 hover:text-white hover:bg-white/10' : 'text-(--color-text-light) hover:text-(--color-text) hover:bg-(--color-bg-alt)'),
                  ]}
                  aria-haspopup={hasChildren ? 'true' : undefined}
                  aria-expanded={hasChildren ? 'false' : undefined}
                >
                  {item.label}
                  {hasChildren && (
                    <svg class="w-3.5 h-3.5 opacity-60 transition-transform duration-200 group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                  )}
                </a>
                {hasChildren && (
                  <div class="dropdown-menu absolute top-full left-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                    <div class="bg-white rounded-xl shadow-xl shadow-black/[0.08] border border-(--color-border-light) py-2 min-w-[220px]">
                      {item.children!.map((child) => {
                        const childPath = child.href.replace(/\/$/, '') || '/';
                        const isChildActive = currentPath === childPath;
                        return (
                          <a
                            href={child.href}
                            class:list={[
                              'block px-4 py-2.5 text-[13px] font-medium transition-colors duration-150',
                              isChildActive
                                ? 'text-(--color-accent) bg-(--color-accent-light)'
                                : 'text-(--color-text-light) hover:text-(--color-text) hover:bg-(--color-bg-alt)',
                            ]}
                          >
                            {child.label}
                          </a>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </nav>

        {socialLinks.length > 0 && (
          <div class="flex items-center gap-1.5 ml-4 pl-4 border-l border-(--color-border-light) header-social-border">
            {socialLinks.map((social) => (
              <a
                href={social.url}
                target="_blank"
                rel="noopener noreferrer"
                class:list={[
                  'header-social-link w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-200 hover:scale-110',
                  transparent ? 'text-white/80 hover:text-white hover:bg-white/10' : 'text-(--color-text-light) hover:text-(--color-text) hover:bg-(--color-bg-alt)',
                ]}
                aria-label={socialLabel(social.platform)}
              >
                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" set:html={socialIcons[social.platform] || ''} />
              </a>
            ))}
          </div>
        )}
      </div>

      <button
        id="mobile-menu-btn"
        class:list={[
          'md:hidden relative w-10 h-10 flex flex-col items-center justify-center gap-1.5 rounded-xl transition-colors',
          transparent ? 'text-white/80 hover:bg-white/10' : 'text-(--color-text-light) hover:bg-(--color-bg-alt)',
        ]}
        aria-label="Menu"
        aria-expanded="false"
      >
        <span class="hamburger-line w-5 h-0.5 bg-current rounded-full transition-all duration-300 origin-center"></span>
        <span class="hamburger-line w-5 h-0.5 bg-current rounded-full transition-all duration-300 origin-center"></span>
        <span class="hamburger-line w-5 h-0.5 bg-current rounded-full transition-all duration-300 origin-center"></span>
      </button>
    </div>
  </div>

  <nav id="mobile-menu" class="md:hidden mobile-menu-enter bg-white border-t border-(--color-border-light)" aria-label="Mobile navigation">
    <div class="max-w-6xl mx-auto px-5 py-3 space-y-1">
      {navigation.map((item) => {
        const itemPath = item.href.replace(/\/$/, '') || '/';
        const isActive = currentPath === itemPath;
        const hasChildren = item.children && item.children.length > 0;
        return (
          <div>
            <a
              href={item.href}
              class:list={[
                'block px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200',
                isActive
                  ? 'text-(--color-accent) bg-(--color-accent-light)'
                  : 'text-(--color-text-light) hover:text-(--color-text) hover:bg-(--color-bg-alt)',
              ]}
            >
              {item.label}
            </a>
            {hasChildren && (
              <div class="pl-4 space-y-0.5">
                {item.children!.map((child) => {
                  const childPath = child.href.replace(/\/$/, '') || '/';
                  const isChildActive = currentPath === childPath;
                  return (
                    <a
                      href={child.href}
                      class:list={[
                        'block px-4 py-2.5 rounded-lg text-sm transition-colors duration-200',
                        isChildActive
                          ? 'text-(--color-accent) bg-(--color-accent-light)'
                          : 'text-(--color-text-muted) hover:text-(--color-text) hover:bg-(--color-bg-alt)',
                      ]}
                    >
                      {child.label}
                    </a>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}
      {socialLinks.length > 0 && (
        <div class="flex items-center gap-2 pt-3 mt-3 border-t border-(--color-border-light) px-4">
          {socialLinks.map((social) => (
            <a
              href={social.url}
              target="_blank"
              rel="noopener noreferrer"
              class="w-9 h-9 flex items-center justify-center rounded-lg text-(--color-text-light) hover:text-(--color-text) hover:bg-(--color-bg-alt) transition-all duration-200"
              aria-label={socialLabel(social.platform)}
            >
              <svg class="w-4.5 h-4.5 fill-current" viewBox="0 0 24 24" set:html={socialIcons[social.platform] || ''} />
            </a>
          ))}
        </div>
      )}
    </div>
  </nav>
</header>

<style>
  #mobile-menu-btn.is-active .hamburger-line:nth-child(1) {
    transform: translateY(8px) rotate(45deg);
  }
  #mobile-menu-btn.is-active .hamburger-line:nth-child(2) {
    opacity: 0;
    transform: scaleX(0);
  }
  #mobile-menu-btn.is-active .hamburger-line:nth-child(3) {
    transform: translateY(-8px) rotate(-45deg);
  }
  /* Transparent header â€” scrolled state overrides */
  header.is-scrolled {
    background: rgba(255,255,255,0.95) !important;
    backdrop-filter: blur(20px);
    border-color: var(--color-border-light) !important;
    box-shadow: 0 1px 16px rgba(0,0,0,0.06);
  }
  header.is-scrolled .header-brand {
    color: var(--color-primary) !important;
  }
  header.is-scrolled .header-nav-link {
    color: var(--color-text-light) !important;
  }
  header.is-scrolled .header-nav-link:hover {
    color: var(--color-text) !important;
    background: var(--color-bg-alt) !important;
  }
  header.is-scrolled .header-social-link {
    color: var(--color-text-light) !important;
  }
  header.is-scrolled .header-social-link:hover {
    color: var(--color-text) !important;
    background: var(--color-bg-alt) !important;
  }
  header.is-scrolled .header-social-border {
    border-color: var(--color-border-light) !important;
  }
  header.is-scrolled #mobile-menu-btn {
    color: var(--color-text-light) !important;
  }
</style>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');
  const header = document.querySelector('header');

  function closeMobileMenu() {
    menu?.classList.remove('is-open');
    btn?.classList.remove('is-active');
    btn?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  }

  function openMobileMenu() {
    menu?.classList.add('is-open');
    btn?.classList.add('is-active');
    btn?.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
  }

  btn?.addEventListener('click', () => {
    const isOpen = menu?.classList.contains('is-open');
    isOpen ? closeMobileMenu() : openMobileMenu();
  });

  // Close mobile menu on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMobileMenu();
      // Also close any open dropdowns
      document.querySelectorAll('.dropdown-parent.is-dropdown-open').forEach((d) => {
        d.classList.remove('is-dropdown-open');
        d.querySelector('[aria-haspopup]')?.setAttribute('aria-expanded', 'false');
      });
    }
  });

  // Close mobile menu when clicking a link inside
  menu?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', closeMobileMenu);
  });

  // Keyboard-accessible dropdowns: toggle on Enter/Space, focus-trap
  document.querySelectorAll('.dropdown-parent').forEach((parent) => {
    const trigger = parent.querySelector('[aria-haspopup]');
    const dropdown = parent.querySelector('.dropdown-menu');
    if (!trigger || !dropdown) return;

    trigger.addEventListener('keydown', (e: Event) => {
      const ke = e as KeyboardEvent;
      if (ke.key === 'Enter' || ke.key === ' ') {
        ke.preventDefault();
        const isOpen = parent.classList.toggle('is-dropdown-open');
        trigger.setAttribute('aria-expanded', String(isOpen));
      }
      if (ke.key === 'ArrowDown') {
        ke.preventDefault();
        parent.classList.add('is-dropdown-open');
        trigger.setAttribute('aria-expanded', 'true');
        (dropdown.querySelector('a') as HTMLElement)?.focus();
      }
    });

    // Close dropdown on focus-out
    parent.addEventListener('focusout', (e: Event) => {
      const fe = e as FocusEvent;
      if (!parent.contains(fe.relatedTarget as Node)) {
        parent.classList.remove('is-dropdown-open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    // Arrow key navigation inside dropdown
    dropdown.querySelectorAll('a').forEach((link, i, links) => {
      link.addEventListener('keydown', (e: Event) => {
        const ke = e as KeyboardEvent;
        if (ke.key === 'ArrowDown') {
          ke.preventDefault();
          (links[i + 1] as HTMLElement)?.focus();
        } else if (ke.key === 'ArrowUp') {
          ke.preventDefault();
          if (i === 0) (trigger as HTMLElement).focus();
          else (links[i - 1] as HTMLElement)?.focus();
        } else if (ke.key === 'Escape') {
          parent.classList.remove('is-dropdown-open');
          trigger.setAttribute('aria-expanded', 'false');
          (trigger as HTMLElement).focus();
        }
      });
    });
  });

  // Transparent header: switch to opaque on scroll
  if (header?.dataset.transparent === 'true') {
    const onScroll = () => {
      header.classList.toggle('is-scrolled', window.scrollY > 60);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  }
</script>
