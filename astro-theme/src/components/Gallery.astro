---
interface Props {
  images: Array<{
    src: string;
    alt?: string;
    width?: number;
    height?: number;
  }>;
  columns?: number;
}

const { images = [], columns = 3 } = Astro.props;

const colClasses: Record<number, string> = {
  2: 'grid-cols-1 sm:grid-cols-2',
  3: 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3',
  4: 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4',
};
---
{images.length > 0 && (
  <Fragment>
    <div class:list={['grid gap-3 sm:gap-4', colClasses[columns] || colClasses[3]]}>
      {images.map((img, idx) => (
        <button
          type="button"
          class="group overflow-hidden rounded-xl bg-(--color-bg-section) cursor-pointer border-0 p-0 focus-visible:ring-2 focus-visible:ring-(--color-accent) focus-visible:ring-offset-2"
          data-lightbox-trigger
          data-index={idx}
          aria-label={img.alt ? `Bild vergrößern: ${img.alt}` : 'Bild vergrößern'}
        >
          <img
            src={img.src}
            alt={img.alt || ''}
            width={img.width}
            height={img.height}
            loading="lazy"
            decoding="async"
            class="w-full h-56 sm:h-64 object-cover transition-transform duration-600 ease-out group-hover:scale-105"
          />
        </button>
      ))}
    </div>

    {/* Lightbox overlay */}
    <div
      data-lightbox
      class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/90 backdrop-blur-sm"
      role="dialog"
      aria-modal="true"
      aria-label="Bildbetrachter"
    >
      <button data-lightbox-close class="absolute top-4 right-4 text-white/80 hover:text-white z-10 p-2" aria-label="Schließen">
        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <button data-lightbox-prev class="absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white z-10 p-2" aria-label="Vorheriges Bild">
        <svg class="w-8 h-8 sm:w-10 sm:h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
      </button>
      <button data-lightbox-next class="absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white z-10 p-2" aria-label="Nächstes Bild">
        <svg class="w-8 h-8 sm:w-10 sm:h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
      </button>
      <img data-lightbox-img class="max-h-[85vh] max-w-[92vw] sm:max-w-[85vw] object-contain rounded-lg shadow-2xl" src="" alt="" />
      <div data-lightbox-counter class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/70 text-sm font-medium"></div>
    </div>
  </Fragment>
)}

<script>
  document.querySelectorAll('[data-lightbox]').forEach((lightbox) => {
    const imgEl = lightbox.querySelector('[data-lightbox-img]') as HTMLImageElement;
    const counterEl = lightbox.querySelector('[data-lightbox-counter]') as HTMLElement;
    const container = lightbox.parentElement;
    if (!container || !imgEl) return;

    const triggers = container.querySelectorAll('[data-lightbox-trigger]');
    const srcs: string[] = [];
    const alts: string[] = [];
    triggers.forEach((t) => {
      const img = t.querySelector('img');
      srcs.push(img?.src || '');
      alts.push(img?.alt || '');
    });

    let current = 0;
    const total = srcs.length;

    function show(idx: number) {
      current = ((idx % total) + total) % total;
      imgEl.src = srcs[current];
      imgEl.alt = alts[current];
      counterEl.textContent = `${current + 1} / ${total}`;
      (lightbox as HTMLElement).style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function hide() {
      (lightbox as HTMLElement).style.display = 'none';
      document.body.style.overflow = '';
    }

    triggers.forEach((t) => {
      t.addEventListener('click', () => show(Number((t as HTMLElement).dataset.index)));
    });

    lightbox.querySelector('[data-lightbox-close]')?.addEventListener('click', hide);
    lightbox.querySelector('[data-lightbox-prev]')?.addEventListener('click', () => show(current - 1));
    lightbox.querySelector('[data-lightbox-next]')?.addEventListener('click', () => show(current + 1));

    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) hide();
    });

    document.addEventListener('keydown', (e) => {
      if ((lightbox as HTMLElement).style.display !== 'flex') return;
      if (e.key === 'Escape') hide();
      if (e.key === 'ArrowLeft') show(current - 1);
      if (e.key === 'ArrowRight') show(current + 1);
    });
  });
</script>
