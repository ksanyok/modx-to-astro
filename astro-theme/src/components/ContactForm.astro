---
interface Props {
  title?: string;
  submitLabel?: string;
  recipientEmail?: string;
}

const {
  title = 'Kontakt',
  submitLabel = 'Absenden',
  recipientEmail = '',
} = Astro.props;

const inputClass = 'w-full rounded-xl border border-(--color-border) bg-(--color-bg-alt)/50 px-4 py-3 text-sm text-(--color-text) placeholder:text-(--color-text-muted) focus:outline-none focus:ring-2 focus:ring-(--color-accent)/30 focus:border-(--color-accent) transition-all duration-200';
---
<div class="max-w-xl mx-auto">
  <div class="bg-(--color-bg) rounded-2xl shadow-lg shadow-black/[0.04] border border-(--color-border-light) p-6 sm:p-8 md:p-10">
    {title && <h2 class="text-2xl sm:text-3xl font-bold mb-8 text-center tracking-tight">{title}</h2>}
    <form class="space-y-5" data-contact-form data-recipient={recipientEmail || undefined}>
      {/* Honeypot anti-spam */}
      <div class="hidden" aria-hidden="true">
        <label for="website">Website</label>
        <input type="text" id="website" name="website" tabindex="-1" autocomplete="off" />
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-(--color-text-light)" for="name">Name *</label>
          <input type="text" id="name" name="name" required aria-required="true" class={inputClass} placeholder="Ihr Name" />
        </div>
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-(--color-text-light)" for="email">E-Mail *</label>
          <input type="email" id="email" name="email" required aria-required="true" class={inputClass} placeholder="name@beispiel.ch" />
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-(--color-text-light)" for="phone">Telefon</label>
        <input type="tel" id="phone" name="phone" class={inputClass} placeholder="+41 ..." />
      </div>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-(--color-text-light)" for="message">Nachricht *</label>
        <textarea id="message" name="message" rows="5" required aria-required="true" class:list={[inputClass, 'resize-y']} placeholder="Ihre Nachricht..."></textarea>
      </div>
      <div class="pt-2">
        <button
          type="submit"
          class="w-full sm:w-auto px-10 py-3.5 bg-(--color-accent) hover:bg-(--color-accent-dark) text-white font-semibold rounded-xl transition-all hover:shadow-lg hover:shadow-(--color-accent)/20 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span data-submit-text>{submitLabel}</span>
          <span data-submit-loading class="hidden items-center gap-2">
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            Senden...
          </span>
        </button>
      </div>
      {/* Success / Error messages */}
      <div data-form-success class="hidden rounded-xl bg-green-50 border border-green-200 p-4 text-sm text-green-800">
        <strong>Vielen Dank!</strong> Ihre Nachricht wurde erfolgreich gesendet.
      </div>
      <div data-form-error class="hidden rounded-xl bg-red-50 border border-red-200 p-4 text-sm text-red-800">
        <strong>Fehler:</strong> Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per E-Mail.
      </div>
    </form>
  </div>
</div>

<script>
  document.querySelectorAll('[data-contact-form]').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target as HTMLFormElement;
      const btn = f.querySelector('button[type="submit"]') as HTMLButtonElement;
      const textEl = f.querySelector('[data-submit-text]') as HTMLElement;
      const loadEl = f.querySelector('[data-submit-loading]') as HTMLElement;
      const successEl = f.querySelector('[data-form-success]') as HTMLElement;
      const errorEl = f.querySelector('[data-form-error]') as HTMLElement;

      // Honeypot
      if ((f.querySelector('[name="website"]') as HTMLInputElement)?.value) return;

      successEl?.classList.add('hidden');
      errorEl?.classList.add('hidden');
      btn.disabled = true;
      textEl?.classList.add('hidden');
      loadEl?.classList.remove('hidden');
      loadEl?.classList.add('inline-flex');

      try {
        const data = new FormData(f);
        data.delete('website');
        const recipient = f.dataset.recipient;

        if (recipient) {
          const subject = encodeURIComponent(`Kontaktanfrage von ${data.get('name')}`);
          const body = encodeURIComponent(
            `Name: ${data.get('name')}\nE-Mail: ${data.get('email')}\nTelefon: ${data.get('phone') || '-'}\n\nNachricht:\n${data.get('message')}`
          );
          window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;
          setTimeout(() => { successEl?.classList.remove('hidden'); f.reset(); }, 500);
        } else {
          const action = f.getAttribute('action');
          if (action) {
            const res = await fetch(action, { method: 'POST', body: data, headers: { Accept: 'application/json' } });
            if (!res.ok) throw new Error('Server error');
          }
          successEl?.classList.remove('hidden');
          f.reset();
        }
      } catch {
        errorEl?.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        textEl?.classList.remove('hidden');
        loadEl?.classList.add('hidden');
        loadEl?.classList.remove('inline-flex');
      }
    });
  });
</script>
